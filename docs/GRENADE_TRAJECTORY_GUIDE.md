# 手榴彈軌跡預測功能說明

## 功能概述

新增的手榴彈軌跡預測功能為玩家提供了直觀的虛線軌跡指示，讓投擲手榴彈變得更加精準和策略性。

## 主要特性

### 1. 真實物理模擬
- **重力影響**: 軌跡考慮 `GRENADE_GRAVITY = 0.3` 的重力影響
- **拋物線飛行**: 完全模擬實際手榴彈的飛行軌跡
- **初始速度**: 使用與實際手榴彈相同的 `GRENADE_SPEED = 10` 參數

### 2. 碰撞檢測
- **平台碰撞**: 軌跡會在碰撞到平台時停止
- **障礙物考慮**: 預測路徑準確反映實際飛行會遇到的障礙
- **黏附預測**: 顯示手榴彈最終會黏附的位置

### 3. 視覺效果

#### 虛線軌跡
- **漸變顏色**: 從綠色（起點）→ 黃色（中段）→ 紅色（終點）
- **虛線樣式**: `dash_length = 8`, `gap_length = 6`
- **線寬變化**: 隨距離漸細，從 3 像素到 1 像素

#### 爆炸範圍指示
- **半透明紅色圓圈**: 顯示 `GRENADE_EXPLOSION_RADIUS = 400` 的爆炸範圍
- **紅色邊框**: 清楚標示危險區域
- **動態顯示**: 只在軌跡終點且在螢幕範圍內時顯示

## 使用方法

### 啟動軌跡預測
1. **按Y鍵** 開啟手榴彈軌跡顯示功能（預設關閉）
2. **按住右鍵** 進入手榴彈瞄準模式
3. **移動滑鼠** 調整投擲方向和力度
4. **觀察虛線軌跡** 預測手榴彈飛行路徑（需先開啟顯示功能）
5. **左鍵投擲** 沿著預測軌跡投出手榴彈

### 控制按鍵
- **Y鍵**: 切換軌跡顯示開啟/關閉
- **H鍵**: 切換手榴彈瞄準模式
- **G鍵**: 投擲手榴彈
- **右鍵**: 引爆所有已投擲的手榴彈

### 軌跡解讀
- **無軌跡**: 軌跡顯示功能關閉（按Y鍵開啟）
- **綠色段**: 手榴彈起飛階段，速度較快
- **黃色段**: 中段飛行，受重力影響明顯
- **紅色段**: 接近落點，下降速度快
- **紅色圓圈**: 爆炸範圍，影響此區域內所有目標

### UI指示說明
遊戲左下角的手榴彈UI會顯示：
- **剩餘數量**: 可投擲的手榴彈數量
- **場上數量**: 已投擲但未引爆的手榴彈
- **瞄準模式**: 是否處於瞄準狀態
- **軌跡顯示**: 軌跡預測功能是否開啟

## 技術實現

### 核心方法
```python
# Player 類中的軌跡計算
def calculate_grenade_trajectory(self, camera_x=0, camera_y=0, platforms=None, max_points=30)

# 主遊戲類中的軌跡繪製
def draw_grenade_trajectory(self)
```

### 物理計算
- **初始速度**: `velocity = direction * GRENADE_SPEED`
- **重力加速**: `velocity_y += GRENADE_GRAVITY` (每幀)
- **位置更新**: `position += velocity` (每幀)

### 碰撞檢測
```python
temp_rect = pygame.Rect(x - GRENADE_SIZE//2, y - GRENADE_SIZE//2, GRENADE_SIZE, GRENADE_SIZE)
collision = temp_rect.colliderect(platform.rect)
```

## 性能優化

### 計算限制
- **最大點數**: `max_points = 50` 防止軌跡過長
- **範圍限制**: 超出 1000x800 像素範圍時停止計算
- **螢幕裁剪**: 只繪製螢幕範圍內的軌跡段

### 繪製優化
- **視錐剔除**: 螢幕外的軌跡段不進行繪製
- **半透明效果**: 使用 `pygame.SRCALPHA` 減少重疊繪製
- **條件性顯示**: 只在手榴彈模式下計算和顯示

## 配置參數

### 軌跡外觀
```python
dash_length = 8      # 虛線段長度
gap_length = 6       # 虛線間隔
line_width = 1-3     # 線寬（隨距離變化）
```

### 爆炸指示
```python
explosion_color = (255, 100, 100, 50)  # 半透明紅色
border_color = (255, 0, 0, 150)        # 邊框顏色
border_width = 2                       # 邊框寬度
```

## 遊戲平衡影響

### 策略性提升
- **精準投擲**: 玩家可以更準確地瞄準敵人
- **障礙物利用**: 可以計算反彈和間接攻擊路線
- **安全距離**: 爆炸範圍指示幫助避免自傷

### 難度調整
- **降低學習曲線**: 新手更容易掌握手榴彈使用
- **提高戰術深度**: 高級玩家可以進行更複雜的戰術規劃
- **保持平衡**: 不改變手榴彈的基本威力和限制

## 故障排除

### 常見問題
1. **軌跡不顯示**: 確保處於手榴彈模式（右鍵按住）
2. **軌跡不準確**: 檢查 `GRENADE_GRAVITY` 和 `GRENADE_SPEED` 設定
3. **性能問題**: 降低 `max_points` 參數

### 調試信息
- 軌跡計算在 `Player.calculate_grenade_trajectory()` 中
- 繪製邏輯在 `ElementalParkourShooter.draw_grenade_trajectory()` 中
- 物理參數在 `config.py` 中統一管理

## 未來擴展

### 可能的改進
- **風力影響**: 考慮關卡中的風力效果
- **材質反彈**: 不同材質的反彈係數
- **軌跡記憶**: 顯示最近幾次投擲的軌跡
- **多重軌跡**: 顯示多種投擲力度的可能軌跡

### 配置選項
- **顯示開關**: 允許玩家關閉軌跡預測
- **複雜度選擇**: 簡單/詳細軌跡模式
- **顏色主題**: 自定義軌跡顏色方案